<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0d0d1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="AIで肌の老化度を分析するPWAアプリ">
  <title>肌診断AI</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Screen 1: Welcome -->
  <div id="screen-welcome" class="screen active">
    <div class="welcome-bg"></div>
    <div class="welcome-content">
      <div class="app-logo">
        <svg viewBox="0 0 120 120" class="logo-svg">
          <defs>
            <linearGradient id="lg1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#e91e8c"/>
              <stop offset="100%" stop-color="#9b59b6"/>
            </linearGradient>
          </defs>
          <ellipse cx="60" cy="58" rx="38" ry="46" fill="none" stroke="url(#lg1)" stroke-width="3"/>
          <circle cx="46" cy="46" r="5" fill="url(#lg1)"/>
          <circle cx="74" cy="46" r="5" fill="url(#lg1)"/>
          <path d="M44 72 Q60 84 76 72" fill="none" stroke="url(#lg1)" stroke-width="3" stroke-linecap="round"/>
          <line x1="10" y1="58" x2="22" y2="58" stroke="url(#lg1)" stroke-width="2" stroke-dasharray="3 2"/>
          <line x1="98" y1="58" x2="110" y2="58" stroke="url(#lg1)" stroke-width="2" stroke-dasharray="3 2"/>
        </svg>
      </div>
      <h1 class="app-title">肌診断 <span class="accent">AI</span></h1>
      <p class="app-subtitle">468点の顔面データをAIが解析<br>あなたの肌年齢を詳しく診断</p>
      <div class="features">
        <div class="feature">
          <span class="feature-icon">🔬</span>
          <div>
            <strong>高精度3D解析</strong>
            <span>MediaPipe Face Meshで468点計測</span>
          </div>
        </div>
        <div class="feature">
          <span class="feature-icon">🦴</span>
          <div>
            <strong>骨格・肌を分離分析</strong>
            <span>改善可能な要因だけを特定</span>
          </div>
        </div>
        <div class="feature">
          <span class="feature-icon">💊</span>
          <div>
            <strong>改善プラン提案</strong>
            <span>ホームケア〜医療処置まで</span>
          </div>
        </div>
      </div>
      <button id="btn-start" class="btn btn-primary">
        <span>診断を開始する</span>
        <span class="btn-arrow">→</span>
      </button>
      <p class="privacy-notice">🔒 撮影データは端末内のみで処理。外部送信なし</p>
    </div>
  </div>

  <!-- Screen 2: Camera -->
  <div id="screen-camera" class="screen">
    <div class="camera-header">
      <button id="btn-back-camera" class="btn-icon-round">←</button>
      <div class="step-progress">
        <div class="step-node active" id="node-0">1</div>
        <div class="step-line" id="line-0"></div>
        <div class="step-node" id="node-1">2</div>
        <div class="step-line" id="line-1"></div>
        <div class="step-node" id="node-2">3</div>
      </div>
      <span id="step-label" class="step-label">1 / 3</span>
    </div>

    <div class="instruction-card" id="instruction-card">
      <div id="pose-emoji" class="pose-emoji">😐</div>
      <div class="instruction-text">
        <h2 id="step-title">正面・無表情</h2>
        <p id="step-desc">カメラを顔の正面に向け、<br>無表情のまま静止してください</p>
      </div>
    </div>

    <div class="camera-viewport">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay-canvas"></canvas>
      <div class="face-oval-guide">
        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
          <ellipse cx="50" cy="50" rx="32" ry="42"
            fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="0.5" stroke-dasharray="3 2"/>
        </svg>
      </div>
      <div id="face-feedback" class="face-feedback detecting">
        <span id="feedback-dot" class="feedback-dot"></span>
        <span id="feedback-text">顔を検出中...</span>
      </div>
    </div>

    <div class="camera-controls">
      <p id="capture-hint" class="capture-hint">顔を枠内に合わせてください</p>
      <div class="capture-row">
        <div class="thumb-slot" id="thumb-0"></div>
        <button id="btn-capture" class="btn-shutter" disabled>
          <div class="shutter-ring"></div>
          <div class="shutter-center"></div>
        </button>
        <div class="thumb-slot" id="thumb-1"></div>
      </div>
    </div>
  </div>

  <!-- Screen 3: Processing -->
  <div id="screen-processing" class="screen">
    <div class="processing-center">
      <div class="ai-sphere">
        <div class="sphere-glow"></div>
        <div class="sphere-icon">🧠</div>
        <div class="ring r1"><span class="ring-dot"></span></div>
        <div class="ring r2"><span class="ring-dot"></span></div>
      </div>
      <h2 class="processing-title">AI解析中...</h2>
      <div class="progress-bar-wrap">
        <div class="progress-track">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <span id="progress-pct">0%</span>
      </div>
      <ul class="analysis-log" id="analysis-log">
        <li id="log-model">⬜ AIモデル準備</li>
        <li id="log-detect">⬜ 顔ランドマーク検出 (3枚)</li>
        <li id="log-nasolabial">⬜ 鼻唇溝（法令線）解析</li>
        <li id="log-cheek">⬜ 頬のたるみ解析</li>
        <li id="log-wrinkle">⬜ シワ・目尻の検出</li>
        <li id="log-bone">⬜ 骨格構造の評価</li>
        <li id="log-score">⬜ 肌年齢スコア算出</li>
      </ul>
    </div>
  </div>

  <!-- Screen 4: Results -->
  <div id="screen-results" class="screen">
    <div class="results-header">
      <h1>診断レポート</h1>
      <div class="header-btns">
        <button id="btn-share" class="btn-sm" title="シェア">📤</button>
        <button id="btn-retry" class="btn-sm" title="再診断">🔄</button>
      </div>
    </div>
    <div id="results-body" class="results-body">
      <!-- dynamically generated -->
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="modal-loading" class="modal hidden">
    <div class="modal-box">
      <div class="spinner"></div>
      <p id="modal-text">AIモデルを読み込み中...</p>
      <p class="modal-sub">初回は30秒ほどかかります</p>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="modal-error" class="modal hidden">
    <div class="modal-box">
      <div class="error-icon">⚠️</div>
      <h3 id="error-title">エラー</h3>
      <p id="error-msg"></p>
      <button id="btn-error-ok" class="btn btn-primary" style="margin-top:16px">OK</button>
    </div>
  </div>

  <!-- TF.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.5/dist/face-landmarks-detection.js"></script>

  <!-- App modules -->
  <script src="js/analyzers/nasolabialAnalyzer.js"></script>
  <script src="js/analyzers/cheekAnalyzer.js"></script>
  <script src="js/analyzers/boneStructureAnalyzer.js"></script>
  <script src="js/analyzers/wrinkleAnalyzer.js"></script>
  <script src="js/analyzers/skinAgeScorer.js"></script>
  <script src="js/results/reportGenerator.js"></script>
  <script src="js/faceDetector.js"></script>
  <script src="js/camera.js"></script>
  <script src="js/app.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.log('SW error:', err));
      });
    }
  </script>
</body>
</html>